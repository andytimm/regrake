% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/regrake.R
\name{regrake}
\alias{regrake}
\title{Optimal representative sample weighting}
\usage{
regrake(
  data,
  formula,
  population_data,
  pop_type = c("raw", "weighted", "proportions", "anesrake", "survey", "survey_design"),
  pop_weights = NULL,
  regularizer = "entropy",
  lambda = 1,
  k = NULL,
  bounds = c(0.1, 10),
  bounds_method = c("soft", "hard"),
  exact_tol = NULL,
  normalize = TRUE,
  control = list(),
  verbose = FALSE,
  ...
)
}
\arguments{
\item{data}{A data.frame or tibble containing the sample data}

\item{formula}{A formula specifying the raking constraints using exact() and l2() terms}

\item{population_data}{A data.frame containing population data, or pre-computed target proportions}

\item{pop_type}{How population data is specified:
\itemize{
\item "raw": Raw population data (one row per unit)
\item "weighted": Population data with weights column
\item "proportions": Direct specification of target proportions (variable, level, target columns)
\item "anesrake": List of named numeric vectors (anesrake package format)
\item "survey": Data frame with margin, category, value columns
\item "survey_design": survey package design object
}}

\item{pop_weights}{Column name in population_data containing weights (if pop_type = "weighted")}

\item{regularizer}{Regularization method ("entropy", "zero", "kl", or "boolean")}

\item{lambda}{Regularization strength (default = 1)}

\item{k}{Number of samples to select (required for regularizer = "boolean")}

\item{bounds}{Numeric vector of length 2 specifying (min, max) allowed weight values.
Weights returned sum to n (sample size), so \code{bounds = c(0.3, 3)} means each weight
is between 0.3 and 3 times the "average" weight of 1. Default is \code{c(0.1, 10)}.}

\item{bounds_method}{How to enforce bounds:
\describe{
\item{"soft"}{(Default) Uses regularizer clipping. Fast but bounds may be
slightly violated when targets conflict with bounds. Asymmetric bounds
are approximated as symmetric.}
\item{"hard"}{Uses bounded simplex projection. Bounds are strictly enforced
but optimization may be slower and targets may be less closely matched
when bounds are binding.}
}}

\item{exact_tol}{Optional tolerance for exact constraints. When non-NULL, all
\code{rr_exact()} (and \code{rr_mean()}) constraints are converted to \code{rr_range()}
with this margin. For example, \code{exact_tol = 0.02} means categorical proportions
must be within +/- 2 percentage points of targets, and continuous means within
+/- 0.02 of targets. Use \code{rr_range()} directly in the formula for per-variable
control. Default is NULL (exact constraints enforced strictly).}

\item{normalize}{Logical. If TRUE (default), continuous variables are automatically
scaled by their target value for numerical stability. The achieved values are
reported in original units. Set to FALSE to disable this behavior.}

\item{control}{List of control parameters for the ADMM solver:
\describe{
\item{margin_tol}{Margin-based convergence tolerance (default 1e-4). The ADMM
solver scales this by problem size to achieve approximately this level of
margin accuracy regardless of sample size or constraint count. For example,
\code{margin_tol = 0.001} targets ~0.1\% max margin error. Internally computes
\code{eps = margin_tol / sqrt(m + 2*n)}. Set to NULL to use raw eps_abs/eps_rel
instead.}
\item{eps_abs}{Absolute convergence tolerance for ADMM residuals. Only used
when margin_tol is NULL. Note: the effective tolerance scales with
\code{sqrt(m + 2*n)}, so the same value behaves differently at different
problem sizes. Default 1e-5.}
\item{eps_rel}{Relative convergence tolerance for ADMM residuals. Only used
when margin_tol is NULL. Default 1e-5.}
\item{rho}{ADMM penalty parameter (default 50).}
\item{maxiter}{Maximum ADMM iterations (default 5000).}
}}

\item{verbose}{Whether to print progress information}

\item{...}{Additional arguments passed to methods}
}
\value{
An object of class \code{"regrake"} containing:
\item{weights}{The optimal weights (sum to n)}
\item{balance}{Data frame comparing achieved vs target values with columns:
constraint (e.g., "exact_sex"), type ("exact" or "l2"), variable,
level, achieved, target, residual}
\item{solution}{Full solution details from solver}
\item{diagnostics}{Weight, convergence, and margin matching diagnostics}
}
\description{
Optimal representative sample weighting
}
